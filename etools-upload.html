<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">

<link rel="import" href="common-styles.html">
<link rel="import" href="common-mixin.html">
<link rel="import" href="request-helper.html">

<dom-module id="etools-upload">
  <template>
    <style include="common-styles">
      #input-main-content {
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      .file-icon {
        padding-right: 8px;
        color: var(--secondary-text-color, rgba(0, 0, 0, 0.54));
      }

      .filename-container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-flex;
        border-bottom: 1px solid var(--secondary-text-color, rgba(0, 0, 0, 0.54));
        margin-right: 8px;
        min-width: 145px;
        overflow-wrap: break-word;
        font-size: 16px;
      }

      .download-button {
        @apply --layout-center-justified;
        padding: 0 0;
        margin-left: 8px;
        color: var(--etools-upload-primary-color, var(--primary-color));
      }

      .dw-icon {
        margin-right: 8px;
      }

      .change-button {
        color: var(--secondary-text-color, rgba(0, 0, 0, 0.54));
      }

      .file-actions paper-button {
        vertical-align: middle;
      }

      .filename-and-actions-container {
        @apply --layout-horizontal;
        @apply --layout-wrap;
      }

      .file-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

    </style>

    <paper-input-container always-float-label="[[alwaysFloatLabel]]"
                           no-label-float="[[!_showLabel(label)]]"
                           disabled$="[[disabled]]" invalid$="[[invalid]]">

      <label slot="label" id="element-label" hidden$="[[!_showLabel(label)]]" aria-hidden="true">[[label]]</label>

      <div id="input-main-content" slot="input">
        <paper-button class="upload-button"
                      on-tap="_openFileChooser"
                      title="[[uploadBtnLabel]]"
                      disabled$="[[readonly]]"
                      hidden$="[[_thereIsAFileSelectedOrSaved(_filename)]]">
          <iron-icon icon="file-upload"></iron-icon>
          [[uploadBtnLabel]]
        </paper-button>

        <div class="filename-and-actions-container">
          <!-- File name container an upload status -->
          <div class="filename-container" hidden$="[[!_thereIsAFileSelectedOrSaved(_filename)]]">
            <iron-icon class="file-icon" icon="attachment"></iron-icon>
            <span class="file-name" title="[[_filename]]">[[_filename]]</span>
          </div>
          <div class="upload-status">
            <paper-spinner id="uploadingSpinner" hidden$="[[!uploadInProgress]]"
                           active="[[uploadInProgress]]"></paper-spinner>
            <iron-icon icon="done" hidden$="[[!success]]"></iron-icon>
            <iron-icon icon="error-outline" hidden$="[[!fail]]"></iron-icon>
          </div>
          <!-- end file name container an upload status -->

          <!-- File actions -->
          <div class="file-actions">
            <paper-button class="download-button"
                          on-tap="_downloadFile"
                          disabled="[[!_showDownloadBtn(fileUrl)]]"
                          hidden$="[[!_showDownloadBtn(fileUrl)]]"
                          title="Download">
              <iron-icon icon="cloud-download" class="dw-icon"></iron-icon>
              Download
            </paper-button>

            <paper-button class="change-button"
                          on-tap="_openFileChooser"
                          disabled$="[[!_showChange(readonly, _filename, uploadInProgress)]]"
                          hidden$="[[!_showChange(readonly, _filename, uploadInProgress)]]">
              Change
            </paper-button>

            <paper-button class="delete-button"
                          on-tap="_deleteFile"
                          disabled$="[[readonly]]"
                          hidden$="[[_hideDeleteBtn(readonly, _filename, showDeleteBtn, uploadInProgress)]]">
              Delete
            </paper-button>

            <paper-button class="delete-button"
                          on-tap="_cancelUpload"
                          disabled$="[[!uploadInProgress]]"
                          hidden$="[[!uploadInProgress]]">
              Cancel
            </paper-button>
          </div>
          <!-- End file actions -->
        </div>

        <!-- Props -->
        <input hidden
               type="file"
               id="fileInput"
               on-change="_fileSelected"
               accept="{{accept}}">

        <a id="downloader" hidden></a>
      </div>

      <template is="dom-if" if="[[invalid]]">
        <paper-input-error aria-live="assertive" slot="add-on">[[errorMessage]]</paper-input-error>
      </template>

    </paper-input-container>

  </template>
  <script>

    /**
     * !!! Important
     * TODO:
     *  - delete method thrown an error, there is no this.files array ?????? No data remains here to use for any other
     *  operation. The only thing that remains is filename everything else is reset
     */


    /**
     * `etools-upload`
     * Use to upload files
     *
     * @customElement
     * @polymer
     * @appliesMixin EtoolsUploadRequest
     * @appliesMixin EtoolsUploadCommon
     * @demo demo/index.html
     */
    class EtoolsUpload extends EtoolsUploadRequest(EtoolsUploadCommon(Polymer.Element)) {
      static get is() {
        return 'etools-upload';
      }

      static get properties() {
        return {
          uploadBtnLabel: {
            type: String,
            value: 'Upload file'
          },
          alwaysFloatLabel: {
            type: Boolean,
            value: true
          },
          fileUrl: {
            type: String,
            value: null,
            observer: '_fileUrlChanged'
          },
          _filename: {
            type: String,
            value: null
          },
          rawFile: {
            type: Object,
            value: null
          },
          showDeleteBtn: {
            type: Boolean,
            value: false
          },
          disabled: Boolean,
          autoValidate: Boolean,
          invalid: Boolean,
          errorMessage: {
            type: String,
            value: ''
          },
          originalErrorMessage: String,
          serverErrorMsg: String,
          success: {
            type: Boolean,
            value: false
          },
          fail: {
            type: Boolean,
            value: false
          }
        };
      }

      static get observers() {
        return [
          'autoValidateHandler(rawFile, fileUrl)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        this.set('originalErrorMessage', this.errorMessage);
      }

      _thereIsAFileSelectedOrSaved(_filename) {
        return !!_filename;
      }

      _fileSelected(e) {
        let file = e.target.files ? e.target.files[0] : null;
        if (!file) {
          return;
        }

        this.resetStatus();
        this.resetValidations();

        this._filename = file.name;
        this.rawFile = file;

        if (this.autoUpload) {
          this._handleUpload();
        }
      }

      _handleUpload() {
        this.uploadInProgress = true;

        this.upload(this.rawFile).then((response) => {
          this.success = true;
          this.uploadInProgress = false;
          this.resetRawFile();
          this.fireEvent('upload-finished', {success: response});
        }).catch((error) => {
          this.fail = true;
          this.serverErrorMsg = 'Error uploading file: ' + error.message;
          this.setInvalid(true, this.serverErrorMsg);
          this.uploadInProgress = false;
          this.fireEvent('upload-finished', {error: error});
        });
      }

      setInvalid(invalid, errMsg) {
        if (typeof errMsg === 'string') {
          this.errorMessage = errMsg;
        }
        this.invalid = invalid;
      }

      resetValidations() {
        this.invalid = false;
        this.errorMessage = null;
      }

      resetStatus() {
        this.success = null;
        this.fail = null;
        this.serverErrorMsg = null;
      }

      _fileUrlChanged(fileUrl) {
        if (!this.isValidURL(fileUrl)) {
          return;
        }
        this.resetStatus();
        this._filename = this.getFilenameFromURL(fileUrl);
      }

      /**
       * Absolute url str needed to work
       * @param str
       * @returns {boolean}
       */
      isValidURL(str) {
        const pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
            '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+ // domain name
            '((\\d{1,3}\\.){3}\\d{1,3}))'+ // ip (v4) address
            '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ //port
            '(\\?[;&amp;a-z\\d%_.~+=-]*)?'+ // query string
            '(\\#[-a-z\\d_]*)?$','i');
        return pattern.test(str);
      }

      getFilenameFromURL(url) {
        if (!url) {
          return '';
        }
        return url.split('?')[0].split('/').pop();
      }

      _showDownloadBtn(fileUrl) {
        return !!fileUrl && this.isValidURL(fileUrl);
      }

      _showChange(readonly, _filename, uploadInProgress) {
        return uploadInProgress ? false : (!readonly && !!_filename);
      }

      _hideDeleteBtn(readonly, _filename, showDeleteBtn, uploadInProgress) {
        if (this.readonly || !this._filename || uploadInProgress) {
          return true;
        }
        return !this.showDeleteBtn;
      }

      _cancelUpload() {
        this.abortActiveRequests();

        this.setProperties({
          uploadInProgress: false,
          _filename: null
        });

        this.resetRawFile();
      }

      _deleteFile(e) {
        if (this.rawFile) {
          this.resetRawFile();
          this._filename = null;
        } else if (!isNaN(this.fileUrl)) {
          this.dispatchEvent(new CustomEvent('delete-file', {
            // TODO: fileUrl will be an id in this case, id that we can use to delete the file from server
            detail: {file: this.fileUrl},
            bubbles: true,
            composed: true
          }));
        }

        this.resetStatus();
        this.resetValidations();
      }

      resetRawFile() {
        this.rawFile = null;
        this.$.fileInput.value = null;
      }

      _downloadFile(e) {
        if (!this.fileUrl || !this.isValidURL(this.fileUrl)) {
          return;
        }

        const a = this.$.downloader;
        a.href = this.fileUrl;
        a.download = this._filename;

        // a.click() doesn't work in ff, edge
        a.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        window.URL.revokeObjectURL(this.fileUrl);
      }

      validate() {
        let valid = true;
        let errMsg = this.originalErrorMessage;
        if (this.required) {
          const uploadReqFailed = this.rawFile instanceof File && this.fail === true;
          if ((!this.rawFile && !this.fileUrl) || uploadReqFailed) {
            valid = false;
          }
          if (uploadReqFailed) {
            errMsg = this.serverErrorMsg;
          }
        }
        this.setInvalid(!valid, errMsg);
        return valid;
      }

      autoValidateHandler() {
        if (this.autoValidate) {
          this.validate();
        }
      }

    }

    window.customElements.define(EtoolsUpload.is, EtoolsUpload);
  </script>
</dom-module>
